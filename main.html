<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snake Game</title>
  <style>
    h1 { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
    body {
      overscroll-behavior: none;
      touch-action: none;
      font-family: "Segoe Print", cursive;
      color: white;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: url("https://i.gifer.com/fzcB.gif") no-repeat center center fixed;
      background-size: cover;
      box-sizing: border-box;
    }
    .content {
      text-align: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      position: relative;
    }
    .menu, .settings, .game-over { display: none; }
    .menu { display: block; }
    .game { display: none; position: relative; } /* –≤—ñ–¥–Ω–æ—Å–Ω–µ –¥–ª—è –∞–±—Å–æ–ª—é—Ç–Ω–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ */
    canvas {
      width: 90vw;
      max-width: 400px;
      height: auto;
      background-color: rgba(0,0,0,0.7);
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
      display: block;
      margin: auto;
      position: relative;
      z-index: 1;
    }
    button {
      background-color: white;
      color: black;
      border: none;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      margin: 10px;
      border-radius: 5px;
      font-family: "Segoe Print", cursive;
      transition: all 0.3s;
    }
    button:hover { background-color: #ddd; transform: scale(1.05); }

    .info-text {
      margin-top: 40px;
      font-size: 14px;
      opacity: 0.8;
      white-space: nowrap;
      text-align: center;
      line-height: 1.4;
    }

    /* Overlay, —â–æ –∑–∞—Ç–µ–º–Ω—é—î –¢–Ü–õ–¨–ö–ò –ø–æ–ª–µ –≥—Ä–∏ */
    .pause-overlay {
      display: none;
      position: absolute;
      z-index: 50;
      left: 50%;
      transform: translateX(-50%);
      top: 50%;
      transform-origin: center;
      border-radius: 8px;
      align-items: center;
      justify-content: center;
    }
    .pause-overlay .backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      z-index: 51;
    }
    .pause-overlay .window {
      position: relative;
      z-index: 52;
      min-width: 220px;
      background: #111;
      border: 2px solid #00ff00;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 0 20px #00ff00;
      text-align: center;
      color: white;
    }
    .pause-overlay .window button { margin: 8px; }

    /* –ö–Ω–æ–ø–∫–∞ –ø–∞—É–∑–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤ —É –ø—Ä–∞–≤–æ–º—É –≤–µ—Ä—Ö–Ω—å–æ–º—É –∫—É—Ç—ñ –∫–∞–Ω–≤–∞—Å—É */
    .mobile-pause-btn {
      position: fixed;
      z-index: 999;
      top: 6px;
      right: 6px;
      background: rgba(0,0,0,0.6);
      color: #00ff00;
      border: 1px solid #00ff00;
      border-radius: 8px;
      width: 40px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
      box-shadow: 0 0 10px #00ff00;
      user-select: none;
    }

    /* –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∫–Ω–æ–ø–∫—É —Å–∏–ª—å–Ω–æ –ø–æ–º—ñ—Ç–Ω–æ –ª–∏—à–µ –Ω–∞ touch-–ø—Ä–∏—Å—Ç—Ä–æ—è—Ö / –º–∞–ª–∏—Ö –µ–∫—Ä–∞–Ω–∞—Ö */
    @media (min-width: 601px) {
      /* —Ö–æ–≤–∞—Ç–∏ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ (–∞–ª–µ –º–æ–∂–Ω–∞ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∑–∞ –±–∞–∂–∞–Ω–Ω—è–º) */
      .mobile-pause-btn { display: none; }
    }

    /* --- Achievements --- */
    #achievementsModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 200;
    }
    #achievementsModal .window {
      background: #111;
      color: white;
      border-radius: 15px;
      border: 2px solid #00ff00;
      padding: 20px;
      width: 320px;
      box-shadow: 0 0 20px #00ff00;
      text-align: left;
    }
    .achievement {
      margin: 8px 0;
      padding: 8px;
      border-radius: 8px;
      transition: 0.3s;
    }
    .achievement.locked {
      opacity: 0.3;
      filter: grayscale(1);
    }
    .popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: #111;
      border: 2px solid #00ff00;
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      box-shadow: 0 0 15px #00ff00;
      opacity: 0;
      transition: opacity 0.5s, transform 0.5s;
      z-index: 300;
    }
    .popup.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      50.1%, 100% { opacity: 0.2; }
    }
  </style>
</head>
<body>
<div class="content">
  <div id="menu" class="menu">
    <h1>Snake Game</h1>
    <p>Best Score: <span id="bestScore">0</span></p>
    <button onclick="startGame()">Play</button>
    <button onclick="openSettings()">Setting</button>
    <br>
    <button onclick="openAchievements()" style="font-size:14px; background:#00c800;">Achievements üèÜ</button>
    <br>
    <button onclick="resetProgress()" style="font-size:13px; background:none; color:#ff4444; text-decoration:underline;">‚Ü∫ Reset progress</button>

    <div class="info-text">
  <div style="display:inline-flex; align-items:center; gap:6px;">
    <button id="whatsNewBtn"
      style="color:#00ffff; font-size:14px; font-weight:600;
             text-decoration:underline; background:none; border:none;
             cursor:pointer; margin-bottom:4px;">
      What's New?
    </button>
    <span id="whatsBadge"
      style="
        display:none;
        width:16px;
        height:16px;
        background:red;
        color:white;
        border-radius:50%;
        font-size:11px;
        font-weight:bold;
        align-items:center;
        justify-content:center;
        display:flex;
        animation:blink 1s infinite;
      ">
      1
    </span>
  </div>
  <br>
  It's better to play on PC!<br>
  Controls: WASD and Swipe ‚Äî Pause: Space / ‚ñê‚ñê (on phone)<br>
  Ver 2.1.3 BETA!
</div>

    <!-- What's New Modal -->
    <div id="whatsNewModal" 
      style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
             justify-content: center; align-items: center; z-index: 100;">
      <div style="background: #111; color: white; border-radius: 15px; border: 2px solid #00ffff;
                  padding: 20px; width: 300px; text-align: center; box-shadow: 0 0 20px #00ffff;">
        <h2 style="color: #00ffff; margin-bottom: 10px;">What's New? ‚ú®</h2>
        <ul style="text-align: left; font-size: 14px; list-style: none; padding-left: 10px;">
          <li>Ver <b>2.1.3 BETA!</b></li>
          <li>Testing leader boards</li>
          
          <li style="margin-top:10px;">Ver <b>2.1.2üíö</b></li>
          <li>‚è∏ <b>Added game pause</li>
          <li>üéµ <b>Added four tracks and removed one track</li>
          <li>‚öô <b>Various small updates</li>
        
          
          <li style="margin-top:10px;">Ver <b>2.0.9</b></li>
          <li>üíæ <b>Added save settings</li>                       
        </ul>
        <button id="closeModal" 
          style="margin-top: 15px; background: #00ffff; color: black; font-weight: bold; 
                 border: none; padding: 6px 12px; border-radius: 10px; cursor: pointer;">
          Close
        </button>
      </div>
    </div>
  </div>

  <div id="settings" class="settings">
    <h2>Settings</h2>
    <label>Snake speed: <span id="speedLabel">(X1)</span></label>
    <input type="range" id="speed" min="0.25" max="2" step="0.25" value="1" onchange="updateSpeed()" />
    <br />
    <label>The color of the Snake:</label>
    <select id="snakeColor">
      <option value="green" selected>Green</option>
      <option value="white">White</option>
      <option value="blue">Blue</option>
      <option value="yellow">Yellow</option>
      <option value="orange">Orange</option>
      <option value="purple">Purple</option>
      <option value="pink">Pink</option>
    </select>
    <br />
    <label>Spawn Apple:</label>
    <select id="appleCount" onchange="updateAppleCount()">
      <option value="1" selected>1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
    </select>
    <br />
    <label>Field size:</label>
    <select id="fieldSize" onchange="updateFieldSize()">
      <option value="small" selected>Small</option>
      <option value="medium">Medium</option>
      <option value="large">Large</option>
    </select>
    <br />
    <button onclick="closeSettings()">Back</button>
  </div>

  <div id="game" class="game">
    <!-- –º–æ–±—ñ–ª—å–Ω–∞ –∫–Ω–æ–ø–∫–∞ –ø–∞—É–∑–∏ (–ø—Ä–∞–≤–∏–π –≤–µ—Ä—Ö–Ω—ñ–π –∫—É—Ç) -->
    <div id="mobilePauseBtn" class="mobile-pause-btn" title="Pause">‚ñê‚ñê</div>

    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <p>Score: <span id="score">0</span></p>

    <!-- Overlay, —â–æ –∑–∞—Ç–µ–º–Ω—é—î –ª–∏—à–µ –ø–æ–ª–µ –≥—Ä–∏ -->
    <div id="pauseOverlay" class="pause-overlay">
      <div class="backdrop"></div>
      <div class="window">
        <h3>Paused</h3>
        <div style="margin-top:8px;">
          <button id="continueBtn">Continue</button>
          <button id="exitBtn" style="background:#ff6666;color:white;">Exit</button>
        </div>
        <p style="font-size:12px; opacity:0.8; margin-top:8px;">Press Space to resume</p>
      </div>
    </div>
  </div>

  <div id="gameOver" class="game-over">
    <h2>Game Over!</h2>
    <p>Score: <span id="finalScore">0</span></p>
    <button onclick="startGame()">Try Again</button>
    <button onclick="goToMenu()">Back</button>
  </div>
</div>

<!-- Achievements Modal -->
<div id="achievementsModal">
  <div class="window">
    <h2 style="color:#00ff00;">Achievements üèÜ</h2>
    <div id="achievementList"></div>
    <button onclick="closeAchievements()" style="margin-top:10px;">Close</button>
  </div>
</div>

<div id="popup" class="popup"></div>

<script>
let menu=document.getElementById("menu"),
    settings=document.getElementById("settings"),
    game=document.getElementById("game"),
    gameOver=document.getElementById("gameOver"),
    canvas=document.getElementById("gameCanvas"),
    ctx=canvas.getContext("2d"),
    scoreEl=document.getElementById("score"),
    finalScoreEl=document.getElementById("finalScore"),
    bestScoreEl=document.getElementById("bestScore");

let snakeColor="green", speed=1, snake, apples, direction, score, interval;
let appleCount=1, fieldSize="small", gridCount=20;
let bestScore=localStorage.getItem('snakeBestScore')||0;
bestScoreEl.innerText=bestScore;

const pauseOverlay = document.getElementById("pauseOverlay");
const mobilePauseBtn = document.getElementById("mobilePauseBtn");
const continueBtn = document.getElementById("continueBtn");
const exitBtn = document.getElementById("exitBtn");

let paused = false;

/* --- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å --- */
const savedSettings = JSON.parse(localStorage.getItem('snakeSettings') || '{}');
if(savedSettings.snakeColor) document.getElementById("snakeColor").value = savedSettings.snakeColor;
if(savedSettings.speed){
  document.getElementById("speed").value = savedSettings.speed;
  speed = parseFloat(savedSettings.speed);
  updateSpeed();
}
if(savedSettings.appleCount){
  document.getElementById("appleCount").value = savedSettings.appleCount;
  appleCount = parseInt(savedSettings.appleCount);
}
if(savedSettings.fieldSize){
  document.getElementById("fieldSize").value = savedSettings.fieldSize;
  fieldSize = savedSettings.fieldSize;
  updateFieldSize();
}

/* --- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å --- */
function saveSettings(){
  const settingsData = {
    snakeColor: document.getElementById("snakeColor").value,
    speed: document.getElementById("speed").value,
    appleCount: document.getElementById("appleCount").value,
    fieldSize: document.getElementById("fieldSize").value
  };
  localStorage.setItem('snakeSettings', JSON.stringify(settingsData));
}

document.getElementById("snakeColor").addEventListener("change", saveSettings);

function openSettings(){ menu.style.display="none"; settings.style.display="block"; }
function closeSettings(){ settings.style.display="none"; menu.style.display="block"; }

function updateSpeed(){
  speed=parseFloat(document.getElementById("speed").value);
  const labels={"0.25":"X0.25","0.5":"X0.5","0.75":"X0.75","1":"X1","1.25":"X1.25","1.5":"X1.5","1.75":"X1.75","2":"X2"};
  document.getElementById("speedLabel").innerText=`(${labels[speed]||'X1'})`;
  saveSettings();
}

function updateAppleCount(){
  appleCount=parseInt(document.getElementById("appleCount").value);
  saveSettings();
}
function updateFieldSize(){
  fieldSize=document.getElementById("fieldSize").value;
  if(fieldSize==="small") gridCount=20;
  else if(fieldSize==="medium") gridCount=30;
  else if(fieldSize==="large") gridCount=40;
  saveSettings();
}

function generateApples(){
  apples=[];
  while(apples.length<appleCount){
    let newApple;
    do{ newApple={x:Math.floor(Math.random()*gridCount),y:Math.floor(Math.random()*gridCount)}; }
    while(snake.some(p=>p.x===newApple.x&&p.y===newApple.y)||apples.some(a=>a.x===newApple.x&&a.y===newApple.y));
    apples.push(newApple);
  }
}

function startGame(){
  menu.style.display="none"; gameOver.style.display="none"; game.style.display="block";
  snakeColor=document.getElementById("snakeColor").value;
  // –ø–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è overlay –Ω–∞–¥ —Å–∞–º–∏–º canvas: –ø—ñ–¥–≥–∞–Ω—è—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ —ñ –ø–æ–∑–∏—Ü—ñ—é
  positionPauseOverlay();
  runGame();
}
function goToMenu(){ gameOver.style.display="none"; menu.style.display="block"; }

/* --- Pause / Resume / Exit logic --- */
function positionPauseOverlay(){
  // –ø—ñ–¥–≥–∞–Ω—è—î–º–æ overlay —Ä–æ–∑–º—ñ—Ä–æ–º —ñ –ø–æ–∑–∏—Ü—ñ—î—é –Ω–∞–¥ canvas
  const rect = canvas.getBoundingClientRect();
  // –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∏–ª—ñ —Ç–∞–∫, —â–æ–± overlay —Ä–æ–∑–º—ñ—â—É–≤–∞–≤—Å—è —Ç–æ—á–Ω–æ –Ω–∞–¥ –∫–∞–Ω–≤–∞—Å–æ–º –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ .game
  const overlay = pauseOverlay;
  overlay.style.display = 'none';
  overlay.style.width = rect.width + 'px';
  overlay.style.height = rect.height + 'px';
  // top –≤—ñ–¥–Ω–æ—Å–Ω–æ .game: –∑–Ω–∞–π–¥–µ–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∫–∞–Ω–≤–∞—Å—É –≤—ñ–¥–Ω–æ—Å–Ω–æ .game
  const gameRect = game.getBoundingClientRect();
  const topOffset = rect.top - gameRect.top;
  overlay.style.top = topOffset + 'px';
  overlay.style.left = (rect.left - gameRect.left + rect.width/2) + 'px'; // –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—É translateX(-50%)
}

window.addEventListener('resize', positionPauseOverlay);
canvas.addEventListener('load', positionPauseOverlay);

/* Toggle pause */
function togglePause(){
  if(paused) resumeGame();
  else pauseGame();
}

function pauseGame(){
  if(paused) return;
  paused = true;
  clearInterval(interval);
  // –ø–æ–∫–∞–∑–∞—Ç–∏ overlay –ø—Ä—è–º–æ –Ω–∞–¥ canvas
  positionPauseOverlay();
  pauseOverlay.style.display = 'flex';
  pauseOverlay.style.alignItems = 'center';
  pauseOverlay.style.justifyContent = 'center';
  // accessibility: focus –Ω–∞ Continue
  continueBtn.focus();
}

function resumeGame(){
  if(!paused) return;
  paused = false;
  // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É
  clearInterval(interval);
  interval = setInterval(updateGame, 200 / speed);
  pauseOverlay.style.display = 'none';
}

/* –í–∏—Ö—ñ–¥ —É –º–µ–Ω—é (Exit) */
function exitToMenu(){
  // –ø—Ä–∏—Ö–æ–≤—É—î–º–æ overlay, –∑—É–ø–∏–Ω—è—î–º–æ –≥—Ä—É —ñ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å —É –º–µ–Ω—é
  paused = false;
  clearInterval(interval);
  pauseOverlay.style.display = 'none';
  if (score > bestScore) {
    bestScore = score;
    localStorage.setItem('snakeBestScore', bestScore);
    bestScoreEl.innerText = bestScore;
  }

  game.style.display = 'none';
  menu.style.display = 'block';
}

/* –∫–Ω–æ–ø–∫–∏ overlay */
continueBtn.addEventListener('click', resumeGame);
exitBtn.addEventListener('click', exitToMenu);

/* –º–æ–±—ñ–ª—å–Ω–∞ –∫–Ω–æ–ø–∫–∞ */
mobilePauseBtn.addEventListener('click', togglePause);

/* --- –û—Å–Ω–æ–≤–Ω–∞ —ñ–≥—Ä–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ --- */
function runGame(){
  // —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
  snake=[{x:Math.floor(gridCount/2),y:Math.floor(gridCount/2)}];
  direction="RIGHT"; score=0; scoreEl.innerText=score;
  generateApples();
  clearInterval(interval);
  interval=setInterval(updateGame,200/speed);
  // –¥–æ–¥–∞—î–º–æ –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞—á—ñ –æ–¥–∏–Ω —Ä–∞–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ (–Ω–µ –¥—É–±–ª—é—î–º–æ)
  if(!window._snakeControlsInit){
    document.addEventListener("keydown", globalKeyHandler);
    window._snakeControlsInit = true;
  }
  // –ø–æ–∑–∏—Ü—ñ—é—î–º–æ overlay
  setTimeout(positionPauseOverlay, 50);
}

function globalKeyHandler(e){
  // —è–∫—â–æ —Ñ–æ–∫—É—Å –Ω–∞ input/select ‚Äî –Ω–µ —Ä–µ–∞–≥—É—î–º–æ –Ω–∞ –ø—Ä–æ–±—ñ–ª –¥–ª—è –ø–∞—É–∑–∏
  const tag = document.activeElement.tagName.toLowerCase();
  if(tag === 'input' || tag === 'select' || tag === 'textarea') {
    // allow using keys there normally
  } else {
    // –ø—Ä–æ–±—ñ–ª ‚Äî –ø–∞—É–∑–∞ / —Ä–µ–∑—é–º–µ
    if(e.code === 'Space'){
      e.preventDefault();
      togglePause();
      return;
    }
    // –∫–ª–∞–≤—ñ—à—ñ WASD –¥–ª—è –Ω–∞–ø—Ä—è–º–∫—É (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ —Å—é–¥–∏)
    changeDirection(e);
  }
}

function updateGame(){
  if(paused) return; // –¥–æ–¥–∞—Ç–∫–æ–≤–∞ –æ—Ö–æ—Ä–æ–Ω–∞
  let head={...snake[0]};
  if(direction==="UP") head.y--;
  if(direction==="DOWN") head.y++;
  if(direction==="LEFT") head.x--;
  if(direction==="RIGHT") head.x++;

  snake.unshift(head);

  for(let i=1;i<snake.length;i++){ if(snake[i].x===head.x&&snake[i].y===head.y){ gameOverScreen(); return; } }

  let ateApple=false;
  apples.forEach((apple,i)=>{
    if(head.x===apple.x&&head.y===apple.y){
      score++; scoreEl.innerText=score; apples.splice(i,1); ateApple=true;
      checkAchievements();
    }
  });

  while(apples.length<appleCount){
    let newApple;
    do{ newApple={x:Math.floor(Math.random()*gridCount),y:Math.floor(Math.random()*gridCount)}; }
    while(snake.some(p=>p.x===newApple.x&&p.y===newApple.y)||apples.some(a=>a.x===newApple.x&&a.y===newApple.y));
    apples.push(newApple);
  }

  if(!ateApple) snake.pop();
  if(head.x<0||head.x>=gridCount||head.y<0||head.y>=gridCount){ gameOverScreen(); return; }

  drawGame();
}

function drawGame(){
  let cellSize=canvas.width/gridCount;
  for(let y=0;y<gridCount;y++){
    for(let x=0;x<gridCount;x++){
      ctx.fillStyle=(x+y)%2===0?"black":"#212121";
      ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
    }
  }

  snake.forEach((part,index)=>{
    ctx.shadowBlur=15; ctx.shadowColor=snakeColor;
    ctx.fillStyle=snakeColor;
    ctx.fillRect(part.x*cellSize,part.y*cellSize,cellSize,cellSize);
    ctx.shadowBlur=0; ctx.shadowColor="transparent";

    if(index===0){
      ctx.fillStyle="black";
      let cx=part.x*cellSize, cy=part.y*cellSize;
      if(direction==="UP"||direction==="DOWN"){
        ctx.beginPath(); ctx.arc(cx+cellSize*0.25,cy+(direction==="UP"?cellSize*0.25:cellSize*0.75),2,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(cx+cellSize*0.75,cy+(direction==="UP"?cellSize*0.25:cellSize*0.75),2,0,Math.PI*2); ctx.fill();
      } else {
        ctx.beginPath(); ctx.arc(cx+(direction==="LEFT"?cellSize*0.25:cellSize*0.75),cy+cellSize*0.25,2,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(cx+(direction==="LEFT"?cellSize*0.25:cellSize*0.75),cy+cellSize*0.75,2,0,Math.PI*2); ctx.fill();
      }
    }
  });

  apples.forEach(a=>{
    ctx.beginPath(); ctx.fillStyle="red";
    ctx.arc(a.x*cellSize+cellSize/2,a.y*cellSize+cellSize/2,cellSize/2,0,Math.PI*2);
    ctx.fill();
  });
}

// –§—É–Ω–∫—Ü—ñ—è gameOverScreen —ñ–∑ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è–º "First loss"
function gameOverScreen(){
  clearInterval(interval);
  game.style.display = "none";
  gameOver.style.display = "block";
  finalScoreEl.innerText = score;
  sendScore(score);

  if(score > bestScore){
    bestScore = score;
    localStorage.setItem('snakeBestScore', bestScore);
    bestScoreEl.innerText = bestScore;
  }

  // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è "First loss" –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –ø—Ä–æ–≥—Ä–∞—à—ñ
  if(!unlocked.includes(2)){
    unlocked.push(2);
    localStorage.setItem('snakeAchievements', JSON.stringify(unlocked));
    showPopup(`Achievement Unlocked! üèÜ<br>First lossüíÄ`);
  }
}

/* --- Controls --- */
function changeDirection(e){
  // –Ø–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–æ –æ–±'—î–∫—Ç –ø–æ–¥—ñ—ó –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ ‚Äî –æ–±—Ä–æ–±–∏—Ç–∏ WASD —Ç–∞ —Å—Ç—Ä—ñ–ª–∫–∏
  const key = (typeof e === 'string') ? e : (e.key || e.code || '').toUpperCase();
  const map = {
    'W':"UP",'A':"LEFT",'S':"DOWN",'D':"RIGHT",
    'ARROWUP':"UP",'ARROWLEFT':"LEFT",'ARROWDOWN':"DOWN",'ARROWRIGHT':"RIGHT",
    'KEYW':"UP",'KEYA':"LEFT",'KEYS':"DOWN",'KEYD':"RIGHT"
  };
  let k = key;
  // —è–∫—â–æ –ø–æ–¥—ñ—è - –æ–±'—î–∫—Ç, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ letter
  if(typeof e !== 'string' && e.key) k = e.key.toUpperCase();
  if(map[k]){
    let newDir = map[k];
    if((direction==="UP"&&newDir==="DOWN")||(direction==="DOWN"&&newDir==="UP")||(direction==="LEFT"&&newDir==="RIGHT")||(direction==="RIGHT"&&newDir==="LEFT")) return;
    direction=newDir;
  }
}

/* --- Touch --- */
let touchStartX=0,touchStartY=0,touchEndX=0,touchEndY=0;
document.body.style.overflow="hidden";
document.body.addEventListener("touchmove",e=>e.preventDefault(),{passive:false});
canvas.addEventListener("touchstart",e=>{const t=e.touches[0]; touchStartX=t.clientX; touchStartY=t.clientY;},{passive:false});
canvas.addEventListener("touchend",e=>{const t=e.changedTouches[0]; touchEndX=t.clientX; touchEndY=t.clientY; handleSwipe();},{passive:false});
function handleSwipe(){
  const diffX=touchEndX-touchStartX, diffY=touchEndY-touchStartY;
  if(Math.abs(diffX)>Math.abs(diffY)){
    if(diffX>30&&direction!=="LEFT") direction="RIGHT";
    else if(diffX<-30&&direction!=="RIGHT") direction="LEFT";
  } else {
    if(diffY>30&&direction!=="UP") direction="DOWN";
    else if(diffY<-30&&direction!=="DOWN") direction="UP";
  }
}

/* --- Achievements --- */
const achievements=[
  {id:1, title:"‚ú®Eat the first apple üçéüêç", condition:1},
  {id:2, title:"First lossüíÄ", condition:"firstLoss"},
  {id:3, title:"Eat twenty apples üçé", condition:20},
  {id:4, title:"Eat forty apples üçé", condition:40},
  {id:5, title:"Eat sixty apples üçé", condition:60},
  {id:6, title:"Eat eighty apples üçé", condition:80},
  {id:7, title:"Eat one hundred apples üçé", condition:100},
];
let unlocked = JSON.parse(localStorage.getItem('snakeAchievements') || '[]');

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—è–≥–Ω–µ–Ω—å –ø—Ä–∏ —ó–∂—ñ —è–±–ª—É–∫–∞
function checkAchievements(){
  achievements.forEach(a => {
    if(typeof a.condition === "number" && score >= a.condition && !unlocked.includes(a.id)){
      unlocked.push(a.id);
      localStorage.setItem('snakeAchievements', JSON.stringify(unlocked));
      showPopup(`Achievement Unlocked! üèÜ<br>${a.title}`);
    }
  });
}

function showPopup(text){
  const popup=document.getElementById("popup");
  popup.innerHTML=text;
  popup.classList.add("show");
  setTimeout(()=>popup.classList.remove("show"),2500);
}

function openAchievements(){
  menu.style.display = "none";
  const modal = document.getElementById("achievementsModal");
  modal.style.display = "flex";

  const list = document.getElementById("achievementList");
  list.innerHTML = "";

  achievements.forEach(a => {
    const div = document.createElement("div");
    div.className = "achievement" + (unlocked.includes(a.id) ? "" : " locked");
    div.innerHTML = a.title;
    list.appendChild(div);
  });
}

function closeAchievements(){
  document.getElementById("achievementsModal").style.display="none";
  menu.style.display="block";
}

function resetProgress(){
  if(confirm("Reset all progress?")){
    localStorage.removeItem('snakeAchievements');
    localStorage.removeItem('snakeBestScore');
    unlocked=[]; bestScore=0; bestScoreEl.innerText=0;
  }
}

/* --- What's New modal --- */
document.getElementById("whatsNewBtn").onclick=()=>{ document.getElementById("whatsNewModal").style.display="flex"; };
document.getElementById("closeModal").onclick=()=>{ document.getElementById("whatsNewModal").style.display="none"; };

/* --- What's New badge logic --- */
const CURRENT_VERSION = "2.1.3"; // ‚Üê –ö–û–õ–ò –û–ù–û–í–ò–® –ö–û–î ‚Äî –ó–ú–Ü–ù–Æ–ô –¶–ï

const whatsBadge = document.getElementById("whatsBadge");
const savedVersion = localStorage.getItem("whatsNewSeen");

// —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –±–∞—á–∏–≤ —Ü—é –≤–µ—Ä—Å—ñ—é ‚Üí –ø–æ–∫–∞–∑—É—î–º–æ "1"
if (savedVersion !== CURRENT_VERSION) {
  whatsBadge.style.display = "inline-flex";
} else {
  whatsBadge.style.display = "none";
}

// –∫–æ–ª–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –≤—ñ–∫–Ω–æ "What's New?"
document.getElementById("whatsNewBtn").addEventListener("click", () => {
  localStorage.setItem("whatsNewSeen", CURRENT_VERSION);
  whatsBadge.style.display = "none";
});
</script>

  <!-- üéµ –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –º—É–∑–∏—á–Ω–∏–π –ø–ª–µ—î—Ä -->
<script src="player.js"></script>

  <!-- === Firebase Leaderboard (for GitHub Pages) === -->
<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, push, query, orderByChild, limitToLast, onValue }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  /* === 1. Firebase config === */
  const firebaseConfig = {
    apiKey: "AIzaSyBFLCSFMOo3Km8gX7N5YLh1Rk1xbP73n2k",
    authDomain: "fsgames-snake-game.firebaseapp.com",
    databaseURL: "https://fsgames-snake-game-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "fsgames-snake-game",
    storageBucket: "fsgames-snake-game.firebasestorage.app",
    messagingSenderId: "423889454890",
    appId: "1:423889454890:web:0462353a54c1689039c053",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const lbRef = ref(db, "leaderboard");

  /* === 2. –°—Ç–≤–æ—Ä—é—î–º–æ –ø–∞–Ω–µ–ª—å === */
  const panel = document.createElement("div");
  Object.assign(panel.style, {
    position: "fixed",
    top: "0",
    left: "-320px",
    width: "300px",
    height: "100vh",
    background: "rgba(0,0,0,0.85)",
    color: "white",
    padding: "20px",
    borderRight: "2px solid #00ff00",
    overflowY: "auto",
    transition: "left 0.35s ease",
    zIndex: "99999",
    fontFamily: "Segoe UI",
  });

  panel.innerHTML = `
    <h2 style="color:#00ff00; text-align:center;">Leaderboard üèÜ</h2>
    <div id="lbList">Loading...</div>
  `;

  document.body.appendChild(panel);

  /* === 3. –ö–Ω–æ–ø–∫–∞ üèÜ === */
  const btn = document.createElement("div");
  btn.innerHTML = "üèÜ";
  Object.assign(btn.style, {
    position: "fixed",
    top: "50%",
    left: "0",
    transform: "translate(0, -50%)",
    background: "#00ff00",
    padding: "10px 14px",
    borderRadius: "12px",
    cursor: "pointer",
    fontSize: "20px",
    zIndex: "100000",
    boxShadow: "0 0 12px #00ff00",
  });

  document.body.appendChild(btn);

  /* === 4. –õ–æ–≥—ñ–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è === */
  let isOpen = false;
  btn.onclick = () => {
    isOpen = !isOpen;
    panel.style.left = isOpen ? "0px" : "-300px";
    if (isOpen) loadLeaderboard();
  };

  /* === 5. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è === */
  function loadLeaderboard() {
    const list = document.getElementById("lbList");
    list.innerHTML = "Loading...";

    const q = query(lbRef, orderByChild("score"), limitToLast(50));

    onValue(q, snapshot => {
      const arr = [];
      snapshot.forEach(s => arr.push(s.val()));
      arr.sort((a, b) => b.score - a.score);

      list.innerHTML = arr.map((x, i) => `
        <div style="padding:6px; border-bottom:1px solid #00ff00;">
          <b>${i + 1}.</b> ${x.name}
          <span style="float:right;color:#00ff00">${x.score}</span>
        </div>
      `).join("");
    });
  }

  /* === 6. –ì–ª–æ–±–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è === */
  window.sendScore = function(score) {
    const name = localStorage.getItem("snakePlayerName") || "Player";
    push(lbRef, {
      name: name,
      score: score,
      time: Date.now(),
    });
  };

</script>
</body>
</html>
